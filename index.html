<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Matriz grande - Rifas & Asociados</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
    :root {
        --cols: 15; /* valor inicial, adaptado por JS */
    }

    body {
        font-family: "Segoe UI", Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background: #f4f6f8;
        color: #222;
    }

    .container {
        max-width: 1100px;
        margin: 0 auto;
    }

    .header {
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:10px;
        flex-wrap:wrap;
    }

    .title {
        font-size: 24px;
        font-weight:700;
    }

    .controls {
        display:flex;
        gap:8px;
        align-items:center;
    }

    .controls input[type="number"] {
        width:80px;
        padding:6px;
        border-radius:6px;
        border:1px solid #ccc;
    }

    .controls button {
        padding:8px 12px;
        border-radius:8px;
        border:none;
        background:#1a73e8;
        color:#fff;
        cursor:pointer;
    }

    .info {
        margin-top:12px;
        color:#444;
        font-size:14px;
    }

    /* Grid */
    .grid-wrapper {
        margin-top:18px;
        background:#fff;
        padding:12px;
        border-radius:10px;
        box-shadow:0 6px 20px rgba(0,0,0,0.08);
    }

    .grid {
        display: grid;
        grid-template-columns: repeat(var(--cols), 1fr);
        gap:8px;
        max-height: 65vh;
        overflow: auto;
        padding:10px;
    }

    .cell {
        display:flex;
        align-items:center;
        justify-content:center;
        user-select: none;
        height:44px;
        border-radius:8px;
        background:#1a8d1a;
        color:#fff;
        font-weight:600;
        cursor:pointer;
        transition: transform .06s ease, box-shadow .06s;
        box-shadow: 0 2px 6px rgba(10,10,10,0.06);
        font-size:13px;
    }

    .cell:active { transform: translateY(1px); }

    .cell.seleccionado { background:#d32f2f; } /* rojo */
    .cell.ocupado {
        background:#e9e9ea !important;
        color:#111 !important;
        cursor:not-allowed !important;
        pointer-events:none;
        box-shadow: none;
    }

    /* footer controls */
    .footer {
        margin-top:14px;
        display:flex;
        gap:8px;
        flex-wrap:wrap;
        align-items:center;
    }

    .btn {
        padding:10px 14px;
        border-radius:8px;
        border:none;
        cursor:pointer;
        font-weight:600;
    }

    .btn-primary { background:#1a73e8; color:#fff; }
    .btn-download { background:#555; color:#fff; }
    .btn-ws { background:#25d366; color:white; }
    .btn-clear { background:#f1f1f1; color:#111; border:1px solid #ddd; }

    /* responsive */
    @media (max-width: 700px) {
        .cell { height:36px; font-size:12px; }
    }
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <div>
            <div class="title">Rifas &amp; Asociados — Matriz grande</div>
            <div class="info">Genera una matriz grande (p. ej. 15×100 = 1500 celdas). Las ocupadas vienen desde <code>boletos.json</code>.</div>
        </div>

        <div class="controls">
            <label>Filas:
                <input id="rowsInput" type="number" min="1" value="100" title="Rows">
            </label>
            <label>Columnas:
                <input id="colsInput" type="number" min="1" value="15" title="Columns">
            </label>
            <button id="generateBtn" title="Generar">Generar</button>
        </div>
    </div>

    <div class="grid-wrapper">
        <div id="grid" class="grid" style="--cols:15"></div>
    </div>

    <div class="footer">
        <button id="clearBtn" class="btn btn-clear">Limpiar selección</button>
        <button id="downloadBtn" class="btn btn-download">Descargar JSON</button>
        <button id="wsBtn" class="btn btn-ws">Enviar por WhatsApp</button>
        <div style="margin-left:auto; color:#666; font-size:13px;">
            Seleccionados: <span id="count">0</span>
        </div>
    </div>
</div>

<script>
/*
  Configurable behavior:
  - Cambia filas/columnas en los inputs y presiona "Generar".
  - El archivo boletos.json debe contener {"ocupados":[n1,n2,...]} en la raíz.
  - Las celdas ocupadas son no seleccionables.
  - MAX recomendado: 5000; 1500 funciona bien.
*/

const grid = document.getElementById('grid');
const rowsInput = document.getElementById('rowsInput');
const colsInput = document.getElementById('colsInput');
const generateBtn = document.getElementById('generateBtn');
const clearBtn = document.getElementById('clearBtn');
const downloadBtn = document.getElementById('downloadBtn');
const wsBtn = document.getElementById('wsBtn');
const countSpan = document.getElementById('count');

let occupiedSet = new Set();
let totalCells = 0;

function pad(num, length=4){ return String(num).padStart(length, '0'); }

async function fetchOccupied() {
    try {
        const res = await fetch('boletos.json?v=' + Date.now()); // anti-cache
        if (!res.ok) { console.warn('boletos.json not found (HTTP ' + res.status + ')'); return []; }
        const data = await res.json();
        return Array.isArray(data.ocupados) ? data.ocupados : [];
    } catch (e) {
        console.warn('Error fetching boletos.json', e);
        return [];
    }
}

function renderGrid(rows, cols) {
    // set CSS var for columns
    grid.style.setProperty('--cols', cols);

    // Clear
    grid.innerHTML = '';
    totalCells = rows * cols;

    const frag = document.createDocumentFragment();

    for (let i = 1; i <= totalCells; i++) {
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.dataset.index = i;
        cell.innerHTML = `<span class="no-select">${pad(i,String(totalCells).length)}</span>`;

        if (occupiedSet.has(i)) {
            cell.classList.add('ocupado');
        } else {
            cell.addEventListener('click', () => {
                cell.classList.toggle('seleccionado');
                updateCount();
            });
        }

        frag.appendChild(cell);
    }

    grid.appendChild(frag);
    updateCount();
}

function updateCount(){
    const n = document.querySelectorAll('.cell.seleccionado').length;
    countSpan.textContent = n;
}

generateBtn.addEventListener('click', async () => {
    const rows = Math.max(1, parseInt(rowsInput.value) || 1);
    const cols = Math.max(1, parseInt(colsInput.value) || 1);

    // safety limit: avoid generating insane amounts unintentionally
    const limit = 5000;
    if (rows * cols > limit) {
        if (!confirm(`Vas a generar ${rows*cols} celdas. Esto puede afectar el navegador. ¿Continuar?`)) return;
    }

    // reload occupied then render
    const occ = await fetchOccupied();
    occupiedSet = new Set(occ.filter(n => Number.isInteger(n) && n >=1));
    renderGrid(rows, cols);
});

// clear selection
clearBtn.addEventListener('click', () => {
    document.querySelectorAll('.cell.seleccionado').forEach(c => c.classList.remove('seleccionado'));
    updateCount();
});

// download JSON of selected (ocupados)
downloadBtn.addEventListener('click', () => {
    const selected = Array.from(document.querySelectorAll('.cell.seleccionado')).map(c => Number(c.dataset.index));
    const payload = { ocupados: selected };
    const blob = new Blob([JSON.stringify(payload, null, 4)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'boletos.json';
    a.click();
    URL.revokeObjectURL(url);
});

// WhatsApp
wsBtn.addEventListener('click', () => {
    const selected = Array.from(document.querySelectorAll('.cell.seleccionado')).map(c => Number(c.dataset.index));
    if (selected.length === 0) { alert('No has seleccionado ningún boleto'); return; }
    const numero = '521111111111'; // reemplaza por tu número
    const mensaje = `Elegí los boletos: ${selected.join(', ')}`;
    const url = `https://wa.me/${numero}?text=${encodeURIComponent(mensaje)}`;
    window.open(url, '_blank');
});

// initial generation with default values
(async function init(){
    const rows = Math.max(1, parseInt(rowsInput.value) || 1);
    const cols = Math.max(1, parseInt(colsInput.value) || 1);
    const occ = await fetchOccupied();
    occupiedSet = new Set(occ.filter(n => Number.isInteger(n) && n >=1));
    renderGrid(rows, cols);
})();
</script>
</body>
</html>
